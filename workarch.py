#!/usr/bin/env python
# -*- coding: utf-8 -*-
import time
import datetime
import os
import threading
from celery import Celery
import urllib
import subprocess

#app = Celery('workarch', broker='amqp://admin:admin@192.168.200.140//', backend='amqp://')
#RESULT = './result/'
app.config_from_object('config')

def execCmd(cmd):
    print cmd
    try:
        print "命令%s开始运行%s" % (cmd, datetime.datetime.now())
        #os.system(cmd)
	rc=subprocess.call(cmd)
	print rc
        print "命令%s结束运行%s" % (cmd, datetime.datetime.now())
    except Exception, e:
        print '%s\t 运行失败,失败原因\r\n%s' % (cmd, e)


@app.task
def add(a, b):
    print 'Start task'
    time.sleep(3)
    print 'Finish task'
    return a + b

@app.task
def scandir(url, dict):
    proto, rest = urllib.splittype(url)
    domain, rest = urllib.splithost(rest)
    print domain + " scan start!"
    #file = RESULT + domain + '.subdomain.txt'
    # subdomain=subdomain.replace('\n','')
    cmd = ['dirb',url,dict]
    #cmd = 'dirb ' + url + ' ' + dict
    print cmd
    # os.system(cmd)
    th = threading.Thread(target=execCmd, args=(cmd,))
    th.start()
    th.join()
    # subdomain=subdomains.readline()
    print domain + " scan end!"
